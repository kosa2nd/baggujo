<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바꾸조</title>
    <link rel="icon" href="../../static/img/favicon.png" type="image/png">
    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootswatch Litera theme -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3/litera/bootstrap.min.css?ver=1.0" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="../../static/css/reset.css?ver=1.0" rel="stylesheet">
    <link href="../../static/css/custom.css" rel="stylesheet">

    <title>바꾸조</title>
</head>
<body>
<th:block th:replace="~{/fragment/header :: headerFragment}"></th:block>

<div class="margin-top container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">교환글 수정</h4>
                </div>
                <div class="card-body">
                    <form id="update-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <button id="edit-image-btn" class="btn btn-light" type="button">이미지 수정</button>
                            <div id="edit-files" style="display: none;">
                                <div id="preview-container" class="mb-2 d-flex"></div>
                                <input type="file" class="form-control border-none" id="files" name="files" onchange="readURL(this);" multiple="multiple">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="title">제목</label>
                            <input type="text" class="form-control" id="title" name="title" th:value="${itemDetail.title}" required>
                        </div>
                        <div class="form-group">
                            <label for="description">내용</label>
                            <textarea class="form-control" id="description" name="description" rows="6" required th:text="${itemDetail.description}"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="itemCategoryId">카테고리</label>
                            <select class="form-control" id="itemCategoryId" name="itemCategoryId" required>
                                <option value="" disabled>카테고리 선택</option>
                                <option th:each="category : ${categories}"
                                        th:value="${category.itemCategoryId}" th:text="${category.itemCategoryName}"
                                        th:selected="${category.itemCategoryName} == ${itemDetail.itemCategoryName}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="condition">사용감</label>
                            <select class="form-control" id="condition" name="itemCondition" required>
                                <option th:each="conditionValue : ${T(com.baggujo.dto.enums.ItemCondition).values()}"
                                        th:value="${conditionValue}" th:text="${conditionValue.kor}"
                                        th:selected="${conditionValue.name()} == ${itemDetail.itemCondition.name()}"></option>
                            </select>
                        </div>
                        <input type="text" id="memberId" name="memberId" th:value="${itemDetail.memberId}" hidden>
                        <input type="text" id="itemStatus" name="itemStatus" th:value="${T(com.baggujo.dto.enums.ItemStatus).WAITING}" hidden>
                        <hr />
                        <button type="submit" class="btn btn-primary w-100">수정</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        $('#edit-image-btn').on('click', function () {
            $('#edit-files').toggle();
        });

        $('#update-form').on('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const filesInput = $('#files')[0];
            if (filesInput.files.length === 0) {
                formData.delete('files');
            }

            const itemId = [[${itemDetail.id}]];
            $.ajax({
                url: `/item/update/${itemId}`,
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    if (response.redirectUrl) {
                        window.location.href = response.redirectUrl;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('게시글 수정 중 오류가 발생했습니다:', error);
                    alert('게시글 수정 중 오류가 발생했습니다.');
                }
            });
        });
    });

    function readURL(input) {
        if (input.files) {
            let previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            Array.from(input.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    let reader = new FileReader();
                    reader.onload = function (e) {
                        let img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.marginRight = '10px';
                        img.style.marginBottom = '10px';
                        img.style.borderRadius = '8px';
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }
</script>
</body>
</html>

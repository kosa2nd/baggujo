<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baggujo.dao.TradeDAO">
    <insert id="insertTradeByRequestId">
        <selectKey order="BEFORE" keyProperty="id" resultType="long">
            select trade_pk_seq.nextval from dual
        </selectKey>
        insert into trade (
            id,
            status,
            request_decision,
            response_decision,
            request_item_id,
            response_item_id)
        select
            #{id},
            #{status},
            #{tradeDecision},
            #{tradeDecision},
            r.request_item_id,
            r.response_item_id
        from request r
        where r.id = #{requestId}
    </insert>

    <select id="getTradeDetailByTradeId" resultType="com.baggujo.dto.TradeDetailDTO">
        select t.id, m1.id requestMemberId, m1.nickname requestNickname, i1.id requestItemId, i1.title requestTitle, m2.id responseMemberId, m2.nickname responseNickname, i2.id responseItemId, i2.title responseTitle
        from trade t, member m1, member m2, item i1, item i2
        where
            t.request_item_id = i1.id
            and
            t.response_item_id = i2.id
            and
            i1.member_id = m1.id
            and
            i2.member_id = m2.id
            and t.id = #{requestId}
    </select>
</mapper>

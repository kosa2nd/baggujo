<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baggujo.dao.ItemDAO">
    <!-- 아이템 생성 -->
    <insert id="insertItem" parameterType="com.baggujo.dto.ItemInsertDTO">
        <selectKey order="BEFORE" keyProperty="id" resultType="long">
            select item_pk_seq.nextval from dual
        </selectKey>
        <![CDATA[
            insert into item (id, title, description, status,
            condition, item_category_id, member_id)
            values(#{id}, #{title}, #{description}, #{itemStatus},
            #{itemCondition}, #{itemCategoryId}, #{memberId})
        ]]>
    </insert>

    <resultMap id="ItemDetailResultMap" type="com.baggujo.dto.ItemDetailDTO">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="uploadDate" column="uploadDate"/>
        <result property="updateDate" column="updateDate"/>
        <result property="itemStatus" column="itemStatus"/>
        <result property="itemCondition" column="itemCondition"/>
        <result property="itemCategoryId" column="itemCategoryId"/>
        <result property="itemCategoryName" column="itemCategoryName"/>
        <result property="memberId" column="member_id"/>
        <result property="nickname" column="nickname"/>
        <collection property="itemImages" ofType="java.lang.String">
            <result column="imgUrl"/>
        </collection>
    </resultMap>


    <!-- 아이템 상세 조회 -->
    <select id="getItemDetailById" parameterType="long" resultMap="ItemDetailResultMap">
        SELECT i.id, i.title, i.description, i.enable,i.UPLOAD_DATE AS uploadDate, i.UPDATE_DATE AS updateDate,
               i.status AS itemStatus, i.condition AS itemCondition,
               i.item_category_id AS itemCategoryId, c.category AS itemCategoryName,
               i.MEMBER_ID AS memberId, m.nickname AS nickname,
               img.name AS imgUrl
        FROM BAGGUJO.ITEM i
                 JOIN ITEM_CATEGORY c ON i.item_category_id = c.id
                 JOIN MEMBER m ON i.MEMBER_ID = m.id
                 LEFT JOIN ITEM_IMAGE img ON i.ID = img.ITEM_ID
        WHERE i.id = #{id}
    </select>


    <!-- 아이템 카테고리 조회 -->
    <select id="getCategories" resultType="com.baggujo.dto.CategoryDTO">
        SELECT id as itemCategoryId, category as itemCategoryName FROM ITEM_CATEGORY
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baggujo.dao.ItemDAO">
    <!-- 아이템 생성 -->
    <insert id="insertItem" parameterType="com.baggujo.dto.ItemInsertDTO">
        <selectKey order="BEFORE" keyProperty="id" resultType="long">
            select item_pk_seq.nextval from dual
        </selectKey>
        <![CDATA[
            insert into item (id, title, description, status,
            condition, item_category_id, member_id)
            values(#{id}, #{title}, #{description}, #{itemStatus},
            #{itemCondition}, #{itemCategoryId}, #{memberId})
        ]]>
    </insert>

    <resultMap id="ItemDetailResultMap" type="com.baggujo.dto.ItemDetailDTO">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="uploadDate" column="uploadDate"/>
        <result property="updateDate" column="updateDate"/>
        <result property="itemStatus" column="itemStatus"/>
        <result property="itemCondition" column="itemCondition"/>
        <result property="itemCategoryId" column="itemCategoryId"/>
        <result property="itemCategoryName" column="itemCategoryName"/>
        <result property="memberId" column="member_id"/>
        <result property="nickname" column="nickname"/>
        <collection property="itemImages" ofType="java.lang.String">
            <result column="imgUrl"/>
        </collection>
    </resultMap>

    <select id="getItemDetailById" parameterType="long" resultMap="ItemDetailResultMap">
        SELECT i.id, i.title, i.description, i.enable,i.upload_date, i.update_date,
               i.status AS itemStatus, i.condition AS itemCondition,
               i.item_category_id, c.category AS itemCategoryName,
               i.member_id, m.nickname,
               img.name AS imgUrl
        FROM item i
        JOIN ITEM_CATEGORY c
            ON i.item_category_id = c.id
        JOIN MEMBER m
            ON i.MEMBER_ID = m.id
        LEFT JOIN ITEM_IMAGE img ON i.ID = img.ITEM_ID
        WHERE i.id = #{id}
    </select>

    <!-- 아이템 카테고리 조회 -->
    <select id="getCategories" resultType="com.baggujo.dto.CategoryDTO">
        SELECT id as itemCategoryId, category as itemCategoryName FROM ITEM_CATEGORY
    </select>

    <!-- 상품리스트 조회 -->
    <select id="getItemPreviews" resultType="com.baggujo.dto.ItemPreviewDTO">
        select * from (
        select i.id, i.title, i.description, i.enable, i.status as itemStatus, i.condition as itemCondition, ii.s_name
        from item i, item_image ii, member m
        join item_image ii on i.id = ii.item_id
        join member m on i.member_id = m.id
        where i.id != #{id}
        order by i.id desc
        )
        offset 0 rows fetch first 12 rows only
    </select>

</mapper>